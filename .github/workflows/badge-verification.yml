name: Badge Verification (Advisory)

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch: {}

permissions: 
  contents: read
  pull-requests: write

jobs:
  verify-badges:
    runs-on: ubuntu-latest
    name: Check README badges (advisory)
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Run badge check
        run: |
          python .github/scripts/badge_check.py
      - name: Upload report for visibility
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: badge-report
          path: badge_report.json
      - name: Post PR comment with report
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          result-encoding: string
          script: |
            const fs = require('fs');
            let body = '### Badge Verification Report\n';
            if (fs.existsSync('badge_report.json')) {
              const report = JSON.parse(fs.readFileSync('badge_report.json', 'utf8'));
              const issues = report.results.filter(r => r.status !== 'OK');
              body += `Checked ${report.results.length} badges: ${report.results.filter(r => r.status === 'OK').length} OK, ${issues.length} issues.`;
              if (issues.length) body += '\n\n**Issues:**\n' + issues.map(i => `- ${i.id} (${i.badge_url}) â†’ ${i.status}`).join('\n');
            } else {
              body += 'No report produced.';
            }
            await github.rest.issues.createComment({owner: context.repo.owner, repo: context.repo.repo, issue_number: context.issue.number, body});
